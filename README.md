# MIAT Action Log Backend

A Node.js/TypeScript backend application for MIAT action logging system with Oracle Database integration.

## Prerequisites

- Node.js (v16 or higher)
- Oracle Database (11g or higher) or Oracle Database XE
- Oracle Instant Client (for oracledb driver)

## Oracle Database Setup

### Option 1: Oracle Database XE (Free)
1. Download Oracle Database XE from Oracle website
2. Install and set up with default settings
3. Default connection: `localhost:1521/xe`

### Option 2: Oracle Cloud (Free Tier)
1. Create an Oracle Cloud account
2. Set up Autonomous Database
3. Get connection string from the cloud console

### Option 3: Existing Oracle Database
1. Get connection details from your DBA
2. Ensure you have necessary privileges

## Installation

1. **Clone and install dependencies:**
   ```bash
   npm install
   ```

2. **Configure environment variables:**
   Edit the `.env` file with your Oracle database credentials:
   ```env
   # Oracle Database Configuration
   DB_USER=your_username
   DB_PASSWORD=your_password
   DB_CONNECTION_STRING=localhost:1521/xe
   
   # Application Configuration
   PORT=3000
   ```

3. **Create database tables (example):**
   ```sql
   CREATE TABLE alog_test (
       id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
       name VARCHAR2(255) NOT NULL
   );
   
   -- Insert some test data (optional)
   INSERT INTO alog_test (name) VALUES ('Test Entry 1');
   INSERT INTO alog_test (name) VALUES ('Test Entry 2');
   INSERT INTO alog_test (name) VALUES ('Test Entry 3');
   COMMIT;
   ```

## Development

1. **Start development server:**
   ```bash
   npm run dev
   ```

2. **Build for production:**
   ```bash
   npm run build
   npm start
   ```

## API Endpoints

### Health Check
- **GET** `/health` - Server health check

### Database Test
- **GET** `/api/test-db` - Test Oracle database connection

### Alog Test Records
- **GET** `/api/alog-test` - Get all records (with pagination)
  - Query parameters: `limit`, `offset`
- **POST** `/api/alog-test` - Create new record
  - Body: `{ name }`
- **GET** `/api/alog-test/:id` - Get record by ID
- **PUT** `/api/alog-test/:id` - Update record by ID
  - Body: `{ name }`
- **DELETE** `/api/alog-test/:id` - Delete record by ID

## Example Usage

### Test Database Connection
```bash
curl http://localhost:3000/api/test-db
```

### Create Record
```bash
curl -X POST http://localhost:3000/api/alog-test \
  -H "Content-Type: application/json" \
  -d '{"name": "My Test Entry"}'
```

### Get All Records
```bash
curl http://localhost:3000/api/alog-test?limit=10&offset=0
```

### Get Record by ID
```bash
curl http://localhost:3000/api/alog-test/1
```

### Update Record
```bash
curl -X PUT http://localhost:3000/api/alog-test/1 \
  -H "Content-Type: application/json" \
  -d '{"name": "Updated Test Entry"}'
```

### Delete Record
```bash
curl -X DELETE http://localhost:3000/api/alog-test/1
```

## Oracle Database Best Practices

1. **Connection Pooling**: The app uses Oracle connection pooling for better performance
2. **Parameterized Queries**: All queries use bind variables to prevent SQL injection
3. **Error Handling**: Comprehensive error handling for database operations
4. **Connection Management**: Automatic connection cleanup and pool management
5. **Graceful Shutdown**: Proper database connection cleanup on app shutdown

## Environment Variables

| Variable | Description | Default | Required |
|----------|-------------|---------|----------|
| `DB_USER` | Oracle database user_name | - | Yes |
| `DB_PASSWORD` | Oracle database password | - | Yes |
| `DB_CONNECTION_STRING` | Oracle connection string | - | Yes |
| `PORT` | Server port | 3000 | No |
| `NODE_ENV` | Environment | development | No |

## Troubleshooting

### Oracle Client Issues
1. **Error: DPI-1047**: Install Oracle Instant Client
   ```bash
   # Windows: Download from Oracle website
   # Linux: 
   wget https://download.oracle.com/otn_software/linux/instantclient/instantclient-basic-linux.zip
   ```

2. **Connection timeout**: Check firewall and network connectivity
3. **TNS errors**: Verify connection string format

### Common Connection Strings
- **Local XE**: `localhost:1521/xe`
- **Local with SID**: `localhost:1521:ORCL`
- **Remote**: `host:port/service_name`
- **TNS**: `(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=host)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=service)))`

## Database Migration

For production deployments, consider using database migration tools:
1. Flyway
2. Liquibase
3. Custom migration scripts

## Security Considerations

1. Never commit `.env` files to version control
2. Use strong database passwords
3. Implement proper authentication/authorization
4. Use HTTPS in production
5. Validate and sanitize all input data
6. Implement rate limiting
7. Use database user with minimal required privileges

## Production Deployment

1. Set `NODE_ENV=production`
2. Use process manager like PM2
3. Set up proper logging
4. Configure reverse proxy (nginx)
5. Use SSL certificates
6. Monitor database connections
7. Set up database backups
